

# Fix Architectural Floor Plan Drawing -- Professional Quality Upgrade

## Overview

12 fixes across 4 files (rendering engine, symbols, drawing sheet, edge function prompt). The changes fall into two categories: **client-side rendering improvements** (Fixes 1-2, 5-12) and **AI prompt improvements** (Fixes 3-4, which improve layout quality at the generation level).

---

## Phase A: Client-Side Rendering Fixes (Files 1-4)

### File 1: `ArchitecturalSymbols.tsx` -- Fixes 1, 10, 12

**Fix 1 -- Window Symbols**: The current `WindowSymbol` draws two parallel lines + a center glass line. The issue is likely that windows are not being generated by the AI (missing from the JSON), or the glass line uses `LIGHT_GRAY` which is too faint. Changes:
- Make the center glass line use `DRAWING_COLORS.BLACK` with `LINE_WEIGHTS.THIN` instead of `LIGHT_GRAY`
- Ensure all three lines are clearly visible at the drawing scale

**Fix 10 -- Room Labels**: Update `RoomLabel` to show ALL CAPS name, dimensions in `W x D` format, and area in SF. The current implementation already does this but we will verify text sizing scales with room size and add a `fontSize` scaling option.

**Fix 12 -- Room Fixtures**: Add new SVG symbol components for architectural fixtures:
- `KitchenFixtures` -- L-shaped counter, sink (double rectangle), stove (rectangle + 4 circles), refrigerator, island
- `BathroomFixtures` -- Toilet (oval + tank rectangle), bathtub/shower (rectangle with diagonal), vanity with basin
- `BedroomFixtures` -- Bed rectangle with pillow rectangles
- `GarageFixtures` -- Dashed car outline rectangles, garage door opening
- `LivingFixtures` -- Sofa L-shape, dining table with chair circles
- `LaundryFixtures` -- Washer/dryer squares with circles inside

All fixtures drawn with `LINE_WEIGHTS.MEDIUM` (0.25mm), outline only, thin lines to not compete with walls.

### File 2: `FloorPlanRenderer.tsx` -- Fixes 2, 5, 7, 8, 9, 11, 12

**Fix 2 -- Dimension Chains on All Four Sides**:
- Add **bottom** horizontal dimension chain (mirror of top)
- Add **right** vertical dimension chain with room depth segments
- Add **left** vertical dimension chain (overall already exists, add segments)
- Compute Y-positions for vertical dimension chains from room boundaries (similar to existing X-position logic)

**Fix 5 -- Wall T-Junction Cleanup**: The `resolveIntersections` logic in `wallGeometry.ts` already handles this, but may need tuning. In the renderer, ensure wall fill uses solid black for interior walls too (not just hatching for exterior).

**Fix 9 -- Line Weight Hierarchy**: Verify and enforce:
- Exterior walls: `LINE_WEIGHTS.CUT_LINE` (2.0) -- already implemented
- Interior walls: `LINE_WEIGHTS.OUTLINE` (1.4) -- already implemented
- Door swing arcs: `LINE_WEIGHTS.DIMENSION` (0.6) -- already implemented
- Dimension lines: `LINE_WEIGHTS.DIMENSION` (0.6) -- already implemented

**Fix 11 -- Wall Poche/Fill**: Change wall fill from hatch patterns to solid fills:
- Exterior walls: `DRAWING_COLORS.BLACK` (solid black fill)
- Interior walls: `DRAWING_COLORS.DARK_GRAY` (#333) fill
- Remove the conditional hatching logic in favor of solid fills (much cleaner look)

**Fix 12 -- Fixtures Layer**: Add a new `<g id="layer-fixtures">` that renders the appropriate fixture component inside each room based on `room.type`:
- `kitchen` -> `KitchenFixtures`
- `bathroom` / `ensuite` -> `BathroomFixtures`
- `bedroom` -> `BedroomFixtures`
- `garage` -> `GarageFixtures`
- `living` / `dining` / `family` -> `LivingFixtures`
- `laundry` / `mudroom` -> `LaundryFixtures`
- Position fixtures within room bounds, offset from walls
- Skip fixtures for very small rooms (closets, hallways)

### File 3: `DrawingSheet.tsx` -- Fixes 6, 7, 8

**Fix 6 -- Title Block**: Redesign the title block to match the professional format:
- Structured grid with project name, drawing title, style, "Generated by AYN"
- Right column: Scale, Date, Sheet number
- Larger text sizes for readability (increase font sizes by ~40%)
- Clean cell dividers

**Fix 7 -- North Arrow**: Already exists in `DrawingSheet`. Verify it renders at a visible size (increase `size` prop from 12 to 16 if needed).

**Fix 8 -- Scale Bar**: Add a new `ScaleBar` component:
- Alternating filled/empty rectangular segments
- Labels: 0, 4', 8', 12', 16'
- Text label below: "SCALE: 1/4" = 1'-0""
- Position near the title block (bottom-right area)

### File 4: `wallGeometry.ts` -- Fix 5

**Fix 5 -- T-Junction Cleanup**: Review the `handleTJunction` function:
- The current logic trims the butting wall to the through-wall's near face, but may select the wrong face depending on wall direction
- Add a direction-aware check: if butting wall comes from above, trim its bottom to the through-wall's top edge; if from below, trim its top to the through-wall's bottom edge
- Same for horizontal butting walls against vertical through-walls

---

## Phase B: AI Prompt Improvements (File 5)

### File 5: `generate-floor-plan-layout/index.ts` -- Fixes 3, 4

**Fix 3 -- Hallway/Circulation**: Add explicit hallway requirements to the system prompt:
- "ALWAYS include a HALLWAY (minimum 3.5ft wide) connecting living areas to bedroom wing"
- "Bedroom doors must open FROM the hallway, not from other bedrooms"
- "Room access chain: Entry -> Living -> Hallway -> Bedrooms + Bathrooms"

**Fix 4 -- Missing Doors**: Strengthen door requirements in the system prompt:
- "EVERY room must have at least one door. Front entry door (36") on the street-facing wall is MANDATORY."
- "Garage-to-house door through mudroom/utility is REQUIRED when garage is present."
- "Every bedroom needs a door from the hallway. Every bathroom needs a door."
- "Master bedroom must have a direct door to the ensuite."

**Window Requirements** (Fix 1 at AI level): Add to prompt:
- "EVERY habitable room on an exterior wall MUST have windows. Living rooms: 2+ windows (48-72" each). Kitchen: 1+ window (36-48"). Bedrooms: 1+ egress window (min 24"W). Generate windows on ALL exterior walls."

---

## Implementation Order

Given the scope, this should be built in 2 implementation rounds:

**Round 1 (Priority -- visual impact)**:
1. Fix 11 (wall poche -- solid black/gray fills) -- biggest visual upgrade, smallest effort
2. Fix 1 (window symbol visibility -- make glass line darker)
3. Fix 2 (dimension chains on all 4 sides)
4. Fix 9 (line weight verification)
5. Fix 5 (T-junction cleanup)
6. Fix 12 (room fixtures -- kitchen, bathroom, bedroom, garage symbols)

**Round 2 (Polish)**:
7. Fix 6 (title block redesign)
8. Fix 8 (scale bar)
9. Fix 10 (room label consistency)
10. Fix 7 (north arrow size check)
11. Fixes 3 + 4 (AI prompt improvements for hallways + doors + windows)

---

## Technical Details

### New Components Added to `ArchitecturalSymbols.tsx`:
- `ScaleBar` -- graphic scale bar with alternating segments
- `KitchenFixtures` -- counter, sink, stove, fridge, island
- `BathroomFixtures` -- toilet, tub/shower, vanity
- `BedroomFixtures` -- bed with pillows
- `GarageFixtures` -- car outlines, garage door
- `LivingFixtures` -- sofa, dining table, chairs
- `LaundryFixtures` -- washer, dryer

### Changes to `FloorPlanRenderer.tsx`:
- Add bottom + right dimension chains
- Add left-side room depth segments
- Add fixtures rendering layer (between walls and labels)
- Change wall fill from hatch to solid black/dark gray
- Reposition room labels to avoid fixture overlap

### Changes to `DrawingSheet.tsx`:
- Redesigned title block with proper grid layout
- Increased font sizes
- Added `ScaleBar` near title block
- Increased north arrow size

### Changes to `wallGeometry.ts`:
- Improved direction-aware T-junction trimming

### Changes to Edge Function:
- Enhanced system prompt with mandatory hallway, door, and window rules
- Added explicit room-access-chain requirement
- Redeploy function after changes

### Files Modified (5 total):
| File | Fixes Addressed |
|------|----------------|
| `ArchitecturalSymbols.tsx` | 1, 8, 10, 12 (new fixture components + scale bar) |
| `FloorPlanRenderer.tsx` | 2, 5, 9, 11, 12 (dims, fills, fixtures layer) |
| `DrawingSheet.tsx` | 6, 7 (title block, north arrow) |
| `wallGeometry.ts` | 5 (T-junction cleanup) |
| `generate-floor-plan-layout/index.ts` | 3, 4 (hallway + doors + windows prompt) |

